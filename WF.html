<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DD Interactive Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root { --primary: #003865; --accent: #ff4b4b; --bg: #f8f9fa; }
        body { display: flex; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); }
        
        /* Sidebar Verticale (Step Tracker) */
        #sidebar { width: 320px; background: white; border-right: 2px solid #ddd; padding: 20px; display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .step-item { padding: 10px; margin-bottom: 10px; border-left: 4px solid #28a745; background: #eefbee; border-radius: 4px; font-size: 0.9em; }
        
        /* Area Orizzontale (Workflow & Controls) */
        #main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #diagram-area { flex: 2; padding: 20px; background: white; display: flex; align-items: center; justify-content: center; overflow: auto; }
        #controls-area { flex: 1; padding: 25px; background: #fff; border-top: 2px solid #ddd; display: flex; flex-direction: column; gap: 15px; }

        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: var(--primary); color: white; font-weight: bold; transition: 0.3s; }
        .btn:hover { opacity: 0.8; }
        .btn-red { background: var(--accent); }
        .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2 style="color: var(--primary)">ðŸ“Ÿ Step Tracker</h2>
        <div id="counter">Step completati: <b>0</b></div>
        <hr>
        <div id="step-log">
            </div>
        <button class="btn btn-red" style="margin-top: auto;" onclick="location.reload()">Resetta Procedura</button>
    </div>

    <div id="main-content">
        <div id="diagram-area">
            <div id="mermaid-container" class="mermaid">
                </div>
        </div>

        <div id="controls-area">
            <h3 id="current-phase-title">Fase 2: Matrice di Scoping</h3>
            <div id="dynamic-controls">
                </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });

        let state = {
            step: 0,
            history: [],
            phase: 'MASTER' // MASTER, SAT_B, SAT_C, END
        };

        const snippets = {
            MASTER: `flowchart LR
                START([RICEZIONE]) --> F2{MATRICE SCOPING}
                F2 --> F3[[SATELLITE B: ASSETTO]]
                F3 --> F4[[SATELLITE C: SCREENING]]
                F4 --> END{REPORTING}
                style F2 fill:#ffd43b`,
            SAT_B: `graph TD
                B1[Triage Fattispecie] --> B2{Soglia?}
                B2 -- 10% --> B3[Look-through Strategico]
                B2 -- 25% --> B4[UBO AML]
                B3 & B4 --> B_End([Consolida Lista])
                style B2 fill:#ffd43b`,
            SAT_C: `graph TD
                C1[Lista Nominativi] --> C2{Rischio?}
                C2 -- Alto --> C3[FULL: DJ Factiva + ORBIS + DD4Eni]
                C2 -- Basso --> C4[ESSENTIAL: Liste Sanzioni]
                C3 & C4 --> C_End([Valutazione Red Flag])
                style C2 fill:#ffd43b`
        };

        function updateUI() {
            // Aggiorna Diagramma
            const container = document.getElementById('mermaid-container');
            container.removeAttribute('data-processed');
            container.innerHTML = snippets[state.phase];
            mermaid.run({ nodes: [container] });

            // Aggiorna Step Tracker
            document.getElementById('counter').innerHTML = `Step completati: <b>${state.step}</b>`;
            const log = document.getElementById('step-log');
            log.innerHTML = state.history.map(h => `<div class="step-item">${h}</div>`).join('');

            // Aggiorna Controlli What/If
            renderControls();
        }

        function renderControls() {
            const ctrl = document.getElementById('dynamic-controls');
            const title = document.getElementById('current-phase-title');
            ctrl.innerHTML = '';

            if (state.phase === 'MASTER') {
                title.innerText = "Fase 2: Scoping Decisionale";
                ctrl.innerHTML = `
                    <p>Qual Ã¨ la natura dell'accordo?</p>
                    <button class="btn" onclick="next('M&A Strategico', 'SAT_B')">M&A / JV / Investimenti</button>
                    <button class="btn" onclick="next('Fornitori/Clienti', 'SAT_B')">Fornitori / Clienti</button>
                `;
            } else if (state.phase === 'SAT_B') {
                title.innerText = "Satellite B: Checkpoint Assetto";
                ctrl.innerHTML = `
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="c1"> Questionario DD Ricevuto</label>
                        <label><input type="checkbox" id="c2"> Visura Camerale Acquisita</label>
                    </div>
                    <button class="btn" style="margin-top:10px" onclick="checkSatB()">Verifica e Procedi</button>
                `;
            } else if (state.phase === 'SAT_C') {
                title.innerText = "Satellite C: Interrogazione Fornitori";
                ctrl.innerHTML = `
                    <p>Seleziona il rischio emerso per vedere i fornitori tecnici:</p>
                    <select id="risk-lvl" onchange="showFornitori(this.value)" style="padding:10px">
                        <option value="">-- Seleziona --</option>
                        <option value="Alto">Rischio Alto</option>
                        <option value="Basso">Rischio Basso</option>
                    </select>
                    <div id="fornitori-info" style="margin-top:10px; font-weight:bold; color:var(--accent)"></div>
                    <button class="btn" id="finish-btn" style="margin-top:10px; display:none" onclick="next('Analisi Conclusa', 'END')">Concludi Analisi</button>
                `;
            } else {
                title.innerText = "Procedura Completata";
                ctrl.innerHTML = `<p>Tutti i checkpoint superati. Generazione Report Form 1/2 in corso...</p>`;
            }
        }

        function next(decision, nextPhase) {
            state.step++;
            state.history.push(decision);
            state.phase = nextPhase;
            updateUI();
        }

        function checkSatB() {
            if (document.getElementById('c1').checked && document.getElementById('c2').checked) {
                next('Assetto Verificato', 'SAT_C');
            } else {
                alert("Devi smarcare tutti i checkpoint documentali!");
            }
        }

        function showFornitori(val) {
            const info = document.getElementById('fornitori-info');
            const btn = document.getElementById('finish-btn');
            if (val === 'Alto') {
                info.innerText = "Sistemi: DD4Eni 2.0 (FULL), DJ Factiva, ORBIS, WCO";
                btn.style.display = 'block';
            } else if (val === 'Basso') {
                info.innerText = "Sistemi: DD4Eni 2.0 (Standard), Liste Sanzioni";
                btn.style.display = 'block';
            }
        }

        // Avvio iniziale
        updateUI();
    </script>
</body>
</html>